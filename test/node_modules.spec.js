import Plugin from '../src'
import * as babel from '@babel/core'
import yaml from 'yaml'
import toml from 'toml'
import fs from 'fs'
import path from 'path'
import { expect } from 'chai'
import { evalTransformed } from './evalTransformed'

describe('node modules', () => {

  it('loads markdown as a string', () => {
    const t = babel.transform(
      `import content from 'import-test-files/simple.md'
        export default content`,
      {
        filename: __filename,
        plugins: [
          [Plugin, {
            transformers: [{
              file: /\.md$/,
              format: 'string'
            }]
          }]
        ]
      }
    )
    const realPath = path.join(__dirname, '../node_modules/import-test-files/simple.md')
    expect(evalTransformed(t)).to.equal(fs.readFileSync(realPath, 'utf-8'))
  })

  it('loads yaml as an object', () => {
    const t = babel.transform(
      `import config from 'import-test-files/simple.yaml';
      export default config`,
      {
        filename: __filename,
        plugins: [
          [Plugin, {
            transformers: [{
              file: /\.ya?ml$/,
              format: 'yaml'
            }]
          }]
        ]
      }
    )

    const realPath = path.join(__dirname, '../node_modules/import-test-files/simple.yaml')
    const data = yaml.parse(fs.readFileSync(realPath, 'utf-8'))
    expect(evalTransformed(t)).to.deep.equal(data)
  })

  it('loads toml as an object', async () => {
    const realPath = path.join(__dirname, '../node_modules/import-test-files/simple.toml')
    const expected = toml.parse(fs.readFileSync(realPath, 'utf-8'))

    const t = await babel.transformAsync(
      `import config from 'import-test-files/simple.toml';
      export default config`,
      {
        filename: __filename,
        plugins: [
          [Plugin, {
            transformers: [{
              file: /\.to?ml$/,
              format: 'toml'
            }]
          }]
        ]
      }
    )

    expect(evalTransformed(t)).to.deep.equal(expected)
  })

  it('loads custom transformer', () => {
    const t = babel.transform(
      `import post from 'import-test-files/yaml-frontmatter.md'
      export default post`,
      {
        filename: __filename,
        plugins: [[
          Plugin,
          {
            transformers: [{
              file: /\.md/,
              transform (contents) {
                return {
                  contents
                }
              }
            }]
          }
        ]]
      }
    )

    expect(evalTransformed(t)).to.deep.equal({
      contents: fs.readFileSync(path.join(__dirname, '../node_modules/import-test-files/yaml-frontmatter.md'), 'utf-8')
    })
  })
})